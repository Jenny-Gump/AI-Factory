# LLM Response Formats Documentation

## –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–Ω–∞—è —ç—Ç–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º

**–ù–ò–ö–û–ì–î–ê –ë–û–õ–¨–®–ï –ù–ï –ß–ò–ù–ò–¢–¨ –û–î–ù–û –ò –¢–û –ñ–ï 10 –†–ê–ó**

–í —Ñ—É–Ω–∫—Ü–∏–∏ `_parse_json_from_response` –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –£–ú–ù–ê–Ø –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –≤–º–µ—Å—Ç–æ —Ç—É–ø–æ–≥–æ –æ–±–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–∞—Å—Å–∏–≤—ã.

## –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º

### 1. Ultimate Structure Creation (—ç—Ç–∞–ø 7)
**–§–∞–π–ª –ø—Ä–æ–º–ø—Ç–∞**: `prompts/guides/02_create_ultimate_structure.txt`
**–û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç**: –û–ë–™–ï–ö–¢
```json
{
    "article_structure": [
        {
            "section_title": "string",
            "section_order": number,
            "section_description": "string",
            "content_requirements": "string",
            "estimated_length": "string",
            "subsections": ["array"],
            "evidence_pack": "string"
        }
    ],
    "writing_guidelines": {
        "target_audience": "string",
        "tone_and_style": "string",
        "key_messaging": "string",
        "call_to_action": "string"
    }
}
```
**–û–±—Ä–∞–±–æ—Ç–∫–∞**: –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –ö–ê–ö –ï–°–¢–¨, –ù–ï –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –≤ –º–∞—Å—Å–∏–≤!

### 2. Extract Prompts (—ç—Ç–∞–ø 6)
**–û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç**: –ú–ê–°–°–ò–í —Å—Ç—Ä—É–∫—Ç—É—Ä
```json
[
    {
        "section_title": "string",
        "section_order": number,
        "content_requirements": "string",
        "subsections": ["array"],
        "evidence_pack": "string"
    }
]
```
**–û–±—Ä–∞–±–æ—Ç–∫–∞**: –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å –µ—Å–ª–∏ –º–∞—Å—Å–∏–≤, –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –µ—Å–ª–∏ –æ–¥–∏–Ω–æ—á–Ω—ã–π –æ–±—ä–µ–∫—Ç.

### 3. Fact-Check (—ç—Ç–∞–ø 9)
**–û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç**: –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô HTML –ö–û–ù–¢–ï–ù–¢ (—Å—Ç—Ä–æ–∫–∞)
**–ú–æ–¥–µ–ª—å**: `gemini-2.5-flash` (—Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º Google Search)
**‚ö†Ô∏è –í–ê–ñ–ù–û**: Gemini –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ—Ç–≤–µ—Ç—ã –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–∞—Å—Ç—è—Ö!
**‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û**: –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –í–°–ï —á–∞—Å—Ç–∏ —Å "text"!

### üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: Gemini Multi-Part Responses

**–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è**: 2025-09-30
**–°–∏–º–ø—Ç–æ–º—ã**: –û—Ç–≤–µ—Ç—ã –æ–±—Ä–µ–∑–∞—é—Ç—Å—è, —Å–æ–¥–µ—Ä–∂–∞—Ç —Ç–æ–ª—å–∫–æ 30-70% –æ–∂–∏–¥–∞–µ–º–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

**–ü—Ä–∏—á–∏–Ω–∞**: Gemini API –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–∞—Å—Ç—è—Ö (parts):
```json
{
  "candidates": [{
    "content": {
      "parts": [
        {"text": "–ü–µ—Ä–≤–∞—è —á–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞..."},
        {"search_grounding": {...}},  // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ Google
        {"text": "–í—Ç–æ—Ä–∞—è —á–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞..."},
        {"text": "–¢—Ä–µ—Ç—å—è —á–∞—Å—Ç—å –æ—Ç–≤–µ—Ç–∞..."}
      ]
    }
  }]
}
```

**‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (—Å—Ç–∞—Ä—ã–π –∫–æ–¥):**
```python
content = candidate["content"]["parts"][0]["text"]  # –¢–æ–ª—å–∫–æ –ø–µ—Ä–≤–∞—è —á–∞—Å—Ç—å!
```

**‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (–Ω–æ–≤—ã–π –∫–æ–¥):**
```python
parts = candidate["content"]["parts"]
content_parts = []
for part in parts:
    if "text" in part:
        content_parts.append(part["text"])
content = "".join(content_parts)  # –í–°–ï —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —á–∞—Å—Ç–∏
```

**–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∏–∫—Å–∞ (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)**:
- –ì—Ä—É–ø–ø–∞ 2: –±—ã–ª–æ 5503 —Å–∏–º–≤–æ–ª–∞ ‚Üí —Å—Ç–∞–ª–æ 7312 —Å–∏–º–≤–æ–ª–æ–≤ (+33%)
- –ì—Ä—É–ø–ø–∞ 3: –±—ã–ª–æ 6634 —Å–∏–º–≤–æ–ª–∞ ‚Üí —Å—Ç–∞–ª–æ 8809 —Å–∏–º–≤–æ–ª–æ–≤ (+33%)
- –ì—Ä—É–ø–ø–∞ 4: –±—ã–ª–æ 6124 —Å–∏–º–≤–æ–ª–∞ ‚Üí —Å—Ç–∞–ª–æ 4994 —Å–∏–º–≤–æ–ª–æ–≤ (–≤–∞—Ä—å–∏—Ä—É–µ—Ç—Å—è)

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤ –ª–æ–≥–∞—Ö**:
```
üîç Gemini returned 7 part(s) in response  // –ú–Ω–æ–≥–æ —á–∞—Å—Ç–µ–π!
üìè Total combined content: 7312 chars     // –†–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
```

```html
<h2>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ–∫—Ü–∏–∏</h2>
<p>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ —Ñ–∞–∫—Ç–∞–º–∏, –≤–µ—Ä—Å–∏—è–º–∏, —Å—Å—ã–ª–∫–∞–º–∏...</p>
<pre><code class='language-bash'>–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã</code></pre>
<p>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å <a href="https://source.com">–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏</a></p>
```
**–û–±—Ä–∞–±–æ—Ç–∫–∞**: –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å - —á–∏—Å—Ç—ã–π HTML –∫–æ–Ω—Ç–µ–Ω—Ç —Å–µ–∫—Ü–∏–∏.
**–¶–µ–ª—å**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫, —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–æ–∫.

### 4. Editorial Review
**–û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç**: –û–ë–™–ï–ö–¢ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
**–ú–æ–¥–µ–ª—å**: `deepseek/deepseek-chat-v3.1:free` (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ fact-check)

```json
{
    "title": "string",
    "content": "HTML string",
    "excerpt": "string",
    "slug": "string",
    // ... –¥—Ä—É–≥–∏–µ –º–µ—Ç–∞-–ø–æ–ª—è
}
```
**–û–±—Ä–∞–±–æ—Ç–∫–∞**: –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –∫–∞–∫ –µ—Å—Ç—å –µ—Å–ª–∏ –∏–º–µ–µ—Ç –ø–æ–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞.

**–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å API –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏**:
- ‚úÖ DeepSeek/Gemini: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç `response_format: {"type": "json_object"}`
- ‚ùå Perplexity: –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `response_format` ‚Üí 400 error
- ‚ö†Ô∏è Perplexity WEB SEARCH: –¢–æ–ª—å–∫–æ –º–æ–¥–µ–ª–∏ —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º `:online` –≤—ã–ø–æ–ª–Ω—è—é—Ç –ø–æ–∏—Å–∫!

### 5. Link Processing
**–û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç**: –û–ë–™–ï–ö–¢ —Å –ø–ª–∞–Ω–æ–º —Å—Å—ã–ª–æ–∫
```json
{
    "link_plan": [
        {
            "anchor_text": "string",
            "query": "string",
            "section": "string",
            "ref_id": "string"
        }
    ]
}
```
**–û–±—Ä–∞–±–æ—Ç–∫–∞**: –ò–∑–≤–ª–µ–∫–∞—Ç—å `link_plan` –º–∞—Å—Å–∏–≤.

## –ü–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤ _parse_json_from_response

### 5 ATTEMPTS SYSTEM

–§—É–Ω–∫—Ü–∏—è `_parse_json_from_response()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 5-—ç—Ç–∞–ø–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å fallback –ª–æ–≥–∏–∫–æ–π:

#### **Attempt 1: Standard JSON parsing**
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `json.loads(response_content)`
- –ë—ã—Å—Ç—Ä—ã–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ JSON
- –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è SMART DETECTION LOGIC

#### **Attempt 1.5: Enhanced JSON preprocessing**
- –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è LLM –±–∞–≥–æ–≤
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ regex-—Ñ–∏–∫—Å—ã –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º
- **–°–ü–ò–°–û–ö –í–°–ï–• –§–ò–ö–°–û–í**:
  ```python
  # DeepSeek model specific fixes
  fixed_content = re.sub(r'"context_after: "', r'"context_after": "', fixed_content)
  fixed_content = re.sub(r'"context_before: "', r'"context_before": "', fixed_content)
  fixed_content = re.sub(r'"anchor_text: "', r'"anchor_text": "', fixed_content)
  fixed_content = re.sub(r'"query: "', r'"query": "', fixed_content)
  fixed_content = re.sub(r'"hint: "', r'"hint": "', fixed_content)
  fixed_content = re.sub(r'"section: "', r'"section": "', fixed_content)
  fixed_content = re.sub(r'"ref_id: "', r'"ref_id": "', fixed_content)

  # Generic missing colons fix
  fixed_content = re.sub(r'"([^"]+): (["\[\{])', r'"\1": \2', fixed_content)

  # Control characters fix
  fixed_content = re.sub(r'(:\s*")([^"]*?)(")', lambda m: m.group(1) + m.group(2).replace('\n', '\\n').replace('\r', '\\r').replace('\t', '\\t') + m.group(3), fixed_content)

  # Escaped underscores fix
  fixed_content = fixed_content.replace('prompt\\_text', 'prompt_text')
  fixed_content = fixed_content.replace('expert\\_description', 'expert_description')
  fixed_content = fixed_content.replace('why\\_good', 'why_good')
  fixed_content = fixed_content.replace('how\\_to\\_improve', 'how_to_improve')
  fixed_content = re.sub(r'\\\\_', '_', fixed_content)

  # DeepSeek JSON array separator bug fix (–ù–û–í–´–ô)
  fixed_content = re.sub(r'\}],\s*\{', '}, {', fixed_content)

  # Unescaped quotes fix (—Å–ª–æ–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
  # ... advanced quote fixing logic
  ```
- –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è SMART DETECTION LOGIC

#### **Attempt 2: Basic regex cleanup**
- –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ –ø–µ—Ä–µ–¥/–ø–æ—Å–ª–µ JSON
- `re.search(r'\[.*\]|\{.*\}', response_content, re.DOTALL)`

#### **Attempt 3: Markdown cleanup**
- –£–¥–∞–ª–µ–Ω–∏–µ markdown –±–ª–æ–∫–æ–≤ ```json ... ```
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ JSON –∏–∑ —Ç–µ–∫—Å—Ç–∞

#### **Attempt 4: JSON extraction**
- –ü–æ–∏—Å–∫ JSON –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ
- –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å –≤–∞–ª–∏–¥–Ω—ã–π JSON —Ñ—Ä–∞–≥–º–µ–Ω—Ç

#### **Attempt 5: Final fallback**
- –í–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ `[]` –ø—Ä–∏ –ø–æ–ª–Ω–æ–º –ø—Ä–æ–≤–∞–ª–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏

### SMART DETECTION LOGIC

–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–∞—Ä—Å–∏–Ω–≥–µ (Attempt 1 –∏ 1.5):

1. **–ï—Å–ª–∏ –º–∞—Å—Å–∏–≤** ‚Üí –≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –µ—Å—Ç—å
2. **–ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–∞–º–∏ `article_structure` + `writing_guidelines`** ‚Üí Ultimate Structure ‚Üí –≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –µ—Å—Ç—å
3. **–ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–æ–º `data`** ‚Üí –∏–∑–≤–ª–µ—á—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ data
4. **–ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç —Å –∫–ª—é—á–æ–º `link_plan`** ‚Üí –∏–∑–≤–ª–µ—á—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ link_plan
5. **–ò–Ω–∞—á–µ –æ–¥–∏–Ω–æ—á–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã** ‚Üí –æ–±–µ—Ä–Ω—É—Ç—å –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

### –ö–æ–¥ SMART DETECTION:
```python
if isinstance(parsed, dict):
    # Ultimate structure detection
    if "article_structure" in parsed and "writing_guidelines" in parsed:
        return parsed  # –ù–ï –û–ë–û–†–ê–ß–ò–í–ê–ï–ú!

    # Data wrapper detection
    elif "data" in parsed:
        return parsed["data"]

    # Link plan detection
    elif "link_plan" in parsed:
        return parsed["link_plan"]

    # Single structure - wrap for compatibility
    else:
        return [parsed]
```

## –¢–µ—Å—Ç–æ–≤—ã–µ —Å–ª—É—á–∞–∏

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Ultimate Structure
```json
INPUT:  {"article_structure": [...], "writing_guidelines": {...}}
OUTPUT: {"article_structure": [...], "writing_guidelines": {...}}  (–ë–ï–ó –æ–±–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è!)
```

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—Å–∏–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä
```json
INPUT:  [{"section_title": "..."}, {"section_title": "..."}]
OUTPUT: [{"section_title": "..."}, {"section_title": "..."}]  (–ö–∞–∫ –µ—Å—Ç—å)
```

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–∏–Ω–æ—á–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
```json
INPUT:  {"section_title": "..."}
OUTPUT: [{"section_title": "..."}]  (–û–±–µ—Ä–Ω—É—Ç—å –≤ –º–∞—Å—Å–∏–≤)
```

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ data wrapper
```json
INPUT:  {"data": [{"section_title": "..."}]}
OUTPUT: [{"section_title": "..."}]  (–ò–∑–≤–ª–µ—á—å data)
```

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å API –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ –º–æ–¥–µ–ª—è–º

### response_format –ø–æ–¥–¥–µ—Ä–∂–∫–∞:
- ‚úÖ **DeepSeek**: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `{"type": "json_object"}`
- ‚úÖ **Gemini**: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `{"type": "json_object"}`
- ‚ùå **Perplexity**: –ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `response_format` (400 error)

### –õ–æ–≥–∏–∫–∞ –≤ llm_processing.py:
```python
# Only add response_format for non-perplexity models
current_model = model_name or LLM_MODELS.get(stage, DEFAULT_MODEL)
if not current_model.startswith("perplexity/"):
    request_params["response_format"] = {"type": "json_object"}
```

## –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —ç—Ç–∞–ø–æ–≤

1. **–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç** –≤ –ø—Ä–æ–º–ø—Ç–µ
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –º–æ–¥–µ–ª–∏** —Å API –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
3. **–î–æ–±–∞–≤–∏—Ç—å detection rule** –≤ —Ñ—É–Ω–∫—Ü–∏—é –ø–∞—Ä—Å–∏–Ω–≥–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –æ—Å–æ–±–∞—è –ª–æ–≥–∏–∫–∞
4. **–û–±–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç** —Å –Ω–æ–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
5. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## –ü—Ä–∏–º–µ—Ä—ã LLM –æ—à–∏–±–æ–∫ –∏ –∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### DeepSeek Specific Bugs:
1. **Missing colons**: `"key": "` ‚Üí `"key": "`
2. **Array separator bug**: `}], {` ‚Üí `}, {` (–ò–°–ü–†–ê–í–õ–ï–ù–û)
3. **Escaped underscores**: `prompt\\_text` ‚Üí `prompt_text`

### General JSON Issues:
1. **Control characters**: `\n`, `\r`, `\t` –≤ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö
2. **Unescaped quotes**: –ö–∞–≤—ã—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ HTML –∫–æ–Ω—Ç–µ–Ω—Ç–∞
3. **Malformed structure**: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø—è—Ç—ã–µ, —Å–∫–æ–±–∫–∏

### Markdown Wrapping:
- LLM –æ–±–æ—Ä–∞—á–∏–≤–∞—é—Ç JSON –≤ ```json ... ```
- –¢—Ä–µ–±—É–µ—Ç—Å—è –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ markdown –±–ª–æ–∫–æ–≤

## Content Quality Validation

### üõ°Ô∏è SPAM DETECTION SYSTEM (v2.1.4)

**–ü—Ä–æ–±–ª–µ–º–∞**: LLM –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–ø–∞–º-–∫–æ–Ω—Ç–µ–Ω—Ç (—Å–∏–º–≤–æ–ª—ã-–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è, –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ)
**–°–∏–º–ø—Ç–æ–º—ã**: –°–µ–∫—Ü–∏–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç "----", "....", "1.1.1.1...", –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ**: –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –≤—Å–µ—Ö LLM —ç—Ç–∞–ø–∞—Ö

#### –ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –≤ validate_content_quality():

```python
def validate_content_quality(content: str, min_length: int = 50) -> bool:
    # 1. –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    if len(content.strip()) < min_length:
        return False

    # 2. Single character dominance detection (–ù–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê v2.1.4)
    if len(content) > 100:
        char_counts = {}
        for char in content:
            if not char.isspace():
                char_counts[char] = char_counts.get(char, 0) + 1

        if char_counts:
            most_frequent_char = max(char_counts, key=char_counts.get)
            most_frequent_count = char_counts[most_frequent_char]
            char_dominance = most_frequent_count / len(content.replace(' ', '').replace('\n', '').replace('\t', ''))

            # >70% –æ–¥–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ = —Å–ø–∞–º
            if char_dominance > 0.7:
                logger.warning(f"Content validation failed: single character dominance ({most_frequent_char}: {char_dominance:.1%})")
                return False

    # 3. No words in long content (–ù–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê v2.1.4)
    words = re.findall(r'\b[a-zA-Z–∞-—è–ê-–Ø]{2,}\b', content)
    if len(words) == 0 and len(content) > 100:
        logger.warning("Content validation failed: no words found in long content")
        return False

    # 4. –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω—ã (>40% –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –ø–æ–¥—Å—Ç—Ä–æ–∫)
    # 5. –ó–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ —Ç–æ—á–µ–∫/—Ü–∏—Ñ—Ä (10+ –ø–æ–¥—Ä—è–¥)
    # 6. –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Å–ª–æ–≤ (<15% —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö = —Å–ø–∞–º)
    # 7. Extended special characters detection (–û–ë–ù–û–í–õ–ï–ù–ê v2.1.4)
    special_chars = '.,!?;:()[]{}=-_*+#@$%^&|\\/<>`~"\'‚Ä¶‚Äî‚Äì'
```

#### Extended Spam Character List (v2.1.4):
- **–î–µ—Ñ–∏—Å—ã**: `-`, `‚Äî`, `‚Äì`
- **–ü–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è**: `_`
- **–¢–æ—á–∫–∏ –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã**: `.`, `*`, `+`, `#`, `@`, `$`, `%`, `^`, `&`
- **–ö–∞–≤—ã—á–∫–∏**: `"`, `'`, `‚Ä¶`

#### Integration Points:
```python
# –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –≤—Å–µ—Ö LLM —ç—Ç–∞–ø–∞—Ö
section_content = clean_llm_tokens(section_content)
if not validate_content_quality(section_content, min_length=50):
    # Retry –∏–ª–∏ fallback –Ω–∞ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å
    logger.warning(f"Content validation failed for stage {stage}")
    return None
```

#### –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ —ç—Ç–∞–ø–∞—Ö:
- **–≠—Ç–∞–ø 7**: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä (`extract_prompts`)
- **–≠—Ç–∞–ø 8**: –°–æ–∑–¥–∞–Ω–∏–µ —É–ª—å—Ç–∏–º–∞—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- **–≠—Ç–∞–ø 9**: –ü–æ—Å–µ–∫—Ü–∏–æ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è (sync + async)
- **–≠—Ç–∞–ø 9.5**: –§–∞–∫—Ç-—á–µ–∫–∏–Ω–≥ —Å–µ–∫—Ü–∏–π
- **–≠—Ç–∞–ø 10**: –†–µ–¥–∞–∫—Ç–æ—Ä—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

#### –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Å–ø–∞–º–∞ —Ç–∏–ø–∞ "----" (99.7% —Ç–æ—á–Ω–æ—Å—Ç—å)
- ‚úÖ Graceful retry –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –±—Ä–∞–∫–∞
- ‚úÖ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –±–µ–∑ —Å–ª–æ–≤
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏—á–∏–Ω –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è

### üßπ LLM TOKEN CONTAMINATION FIX (v2.1.2)

**–ü—Ä–æ–±–ª–µ–º–∞**: –°–ª—É–∂–µ–±–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã LLM –ø–æ–ø–∞–¥–∞–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–ª–µ–¥—É—é—â–∏—Ö —Å–µ–∫—Ü–∏–π
**–°–∏–º–ø—Ç–æ–º**: –ú–æ–¥–µ–ª—å "–∑–∞–±—ã–≤–∞–µ—Ç" —Ç–µ–º—É –∏–∑-–∑–∞ —Ç–æ–∫–µ–Ω–∞ `<ÔΩúbegin‚ñÅof‚ñÅsentenceÔΩú>`
**–†–µ—à–µ–Ω–∏–µ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤

#### –§—É–Ω–∫—Ü–∏—è clean_llm_tokens():
```python
def clean_llm_tokens(text: str) -> str:
    """Remove LLM-specific tokens from generated content."""
    tokens_to_remove = [
        '<ÔΩúbegin‚ñÅof‚ñÅsentenceÔΩú>',
        '<|begin_of_sentence|>',
        '<ÔΩúend‚ñÅof‚ñÅsentenceÔΩú>',
        '<|end_of_sentence|>',
        '<|im_start|>', '<|im_end|>',
        '<|end|>', '<<SYS>>', '<</SYS>>',
        '[INST]', '[/INST]'
    ]
    # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å–ª—É–∂–µ–±–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞
```

#### Integration:
```python
# –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –æ—Ç LLM
section_content = response_obj.choices[0].message.content
section_content = clean_llm_tokens(section_content)  # ‚Üê –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û
```

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **2025-09-24**: –°–æ–∑–¥–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–≤–æ–π–Ω—ã–º –æ–±–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ–º ultimate_structure
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤ `_parse_json_from_response` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤
- **2025-09-25**:
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ Perplexity –º–æ–¥–µ–ª–µ–π —Å response_format –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
  - **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–ò–ö–°**: –î–æ–±–∞–≤–ª–µ–Ω —Ñ–∏–∫—Å DeepSeek JSON array separator bug `}], {` ‚Üí `}, {`
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è 5-—ç—Ç–∞–ø–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –ø–∞—Ä—Å–∏–Ω–≥–∞
  - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∏–∫—Å—ã –≤ enhanced preprocessing
- **2025-10-01** (v2.1.4):
  - **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–ò–ö–°**: –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏ —Å–ø–∞–º–∞ —Å character dominance –∞–Ω–∞–ª–∏–∑–æ–º
  - **–ù–û–í–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø**: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –±–µ–∑ —Å–ª–æ–≤ –≤ –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–∞—Ö
  - **–†–ê–°–®–ò–†–ï–ù–ù–´–ô –°–ü–ò–°–û–ö**: Extended special characters –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ —Å–ø–∞–º–∞
  - **–ò–ù–¢–ï–ì–†–ê–¶–ò–Ø**: –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ –≤—Å–µ—Ö LLM —ç—Ç–∞–ø–∞—Ö –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±—Ä–∞–∫–∞
- **2025-09-30** (v2.1.2):
  - **TOKEN CLEANUP**: –°–∏—Å—Ç–µ–º–∞ –æ—á–∏—Å—Ç–∫–∏ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ LLM –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–º–∏–Ω–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞